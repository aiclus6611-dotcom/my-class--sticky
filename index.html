<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµæ§‹åŒ–äº’å‹•ç™½æ¿</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        body { font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; background-color: #333; margin: 0; padding: 0; overflow: hidden; }
        
        /* --- é€šç”¨å…ƒä»¶ --- */
        .btn { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-size: 1rem; margin: 5px; transition: 0.2s; white-space: nowrap;}
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background: #1976d2; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-danger { background: #d32f2f; color: white; }
        .btn-secondary { background: #757575; color: white; }
        .btn-upload { background: #ff9800; color: white; display: inline-block; cursor: pointer; }
        .btn-icon { background: transparent; color: #ccc; font-size: 1.2rem; padding: 5px 10px; }
        .btn-icon:hover { color: white; background: rgba(255,255,255,0.1); }
        
        input, select { padding: 10px; border-radius: 4px; border: 1px solid #ccc; font-size: 1rem; box-sizing: border-box; }

        /* --- å­¸å“¡ç«¯æ¨£å¼ --- */
        .student-wrapper {
            background-color: #f0f2f5; height: 100vh; overflow-y: auto; padding: 20px; box-sizing: border-box;
        }
        .student-container { 
            max-width: 600px; margin: 0 auto; padding-bottom: 50px;
        }
        .zone-card {
            background: white; padding: 20px; border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px;
            border-left: 6px solid #1976d2; 
        }
        .zone-card h3 { margin: 0 0 10px 0; color: #333; display: flex; justify-content: space-between; align-items: center; }
        .zone-hint { font-size: 0.85rem; color: #888; font-weight: normal; }
        .input-row { display: flex; gap: 10px; }
        .input-row input { flex: 1; }
        .zone-card:nth-child(4n+1) { border-left-color: #fbc02d; }
        .zone-card:nth-child(4n+2) { border-left-color: #42a5f5; }
        .zone-card:nth-child(4n+3) { border-left-color: #66bb6a; }
        .zone-card:nth-child(4n+4) { border-left-color: #ef5350; }

        .my-list-section { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .my-item { 
            background: #fafafa; padding: 15px; margin-bottom: 10px; border-radius: 8px; 
            border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
        }
        .note-tag {
            display: inline-block; background: #e3f2fd; color: #1565c0;
            font-size: 0.8rem; padding: 2px 8px; border-radius: 4px; 
            margin-bottom: 4px; font-weight: bold; margin-right: 5px;
        }

        /* --- è¬›å¸«ç«¯æ¨£å¼ (ç™½æ¿) --- */
        .teacher-board { 
            position: relative; width: 100vw; height: 100vh; overflow: hidden; 
            background-color: #e0e0e0; 
            background-size: contain; 
            background-repeat: no-repeat;
            background-position: center;
        }

        /* æ”¹é€²å¾Œçš„è¬›å¸«æ§åˆ¶å° */
        /* 1. è§¸ç™¼æŒ‰éˆ• (é è¨­é¡¯ç¤º) */
        .toolbar-trigger {
            position: fixed; bottom: 20px; right: 20px;
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(0,0,0,0.4); color: white;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; cursor: pointer; z-index: 2000;
            transition: 0.3s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .toolbar-trigger:hover { background: rgba(0,0,0,0.8); transform: scale(1.1); }

        /* 2. æ§åˆ¶å°æœ¬é«” (å±•é–‹æ™‚) */
        .toolbar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(0, 0, 0, 0.9); 
            padding: 15px 20px; 
            z-index: 2001; 
            display: flex; justify-content: space-between; align-items: center;
            color: white;
            animation: slideUp 0.3s ease-out;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* ä¾¿åˆ©è²¼æ¨£å¼ */
        .sticky-note {
            position: absolute; width: 180px; min-height: 100px;
            background: #ffeb3b; padding: 15px;
            box-shadow: 2px 5px 15px rgba(0,0,0,0.3);
            font-size: 1.1rem; line-height: 1.4;
            cursor: grab; transform: rotate(-1deg);
            transition: box-shadow 0.2s, transform 0.1s;
            border-radius: 2px 2px 15px 2px; word-wrap: break-word; z-index: 100;
        }
        .sticky-note:active { cursor: grabbing; transform: scale(1.05); z-index: 999; }
        .sticky-tag {
            display: inline-block; background: rgba(0,0,0,0.1); 
            font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; 
            margin-bottom: 5px; color: #444; font-weight: bold;
        }
        .note-close { 
            position: absolute; top: -10px; right: -10px; width: 24px; height: 24px; 
            background: red; color: white; border-radius: 50%; text-align: center; 
            line-height: 22px; cursor: pointer; font-size: 14px; display: none; z-index: 101;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .sticky-note:hover .note-close { display: block; }
        .color-1 { background: #fff9c4; } 
        .color-2 { background: #b3e5fc; } 
        .color-3 { background: #c8e6c9; } 
        .color-4 { background: #ffcdd2; } 

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 3000;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-box {
            background: white; padding: 25px; border-radius: 10px; width: 500px; max-width: 90%;
            max-height: 80vh; overflow-y: auto;
        }
        .zone-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .zone-row input { flex: 1; }
        .edit-modal { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; }
    </style>
</head>
<body>
    <div id="app">
        <div v-if="isLoading" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); color:white; display:flex; justify-content:center; align-items:center; z-index:9999;">
            è¼‰å…¥ä¸­...
        </div>

        <div v-if="isTeacher" class="teacher-board" :style="{ backgroundImage: 'url(' + bgImage + ')' }">
            
            <div v-for="note in notes" 
                 :key="note.key"
                 class="sticky-note"
                 :class="getColorClass(note.key)"
                 :style="{ left: note.x + 'px', top: note.y + 'px' }"
                 @mousedown="startDrag($event, note)"
            >
                <div v-if="note.zoneName" class="sticky-tag">{{ note.zoneName }}</div>
                {{ note.text }}
                <div class="note-close" @click.stop="deleteNote(note.key)">âœ•</div>
            </div>

            <div v-if="showToolbar" class="toolbar">
                <div style="display:flex; gap:10px; align-items:center;">
                    <strong style="font-size:1.1rem;">è¬›å¸«æ§åˆ¶å°</strong>
                    <span style="color:#bbb; font-size:0.9rem;">(ä¾¿åˆ©è²¼: {{ notes.length }})</span>
                </div>
                
                <div style="display:flex; align-items:center; gap: 5px;">
                    <button class="btn btn-primary" @click="showZoneModal = true">âš™ï¸ è¨­å®šåˆ†å€</button>
                    <label class="btn btn-upload">
                        ğŸ–¼ï¸ èƒŒæ™¯
                        <input type="file" accept="image/*" style="display: none;" @change="handleBgUpload">
                    </label>
                    <button class="btn btn-danger" @click="clearBoard">ğŸ—‘ï¸ æ¸…ç©º</button>
                    
                    <div style="width:1px; height:25px; background:#555; margin:0 10px;"></div>
                    
                    <button class="btn btn-icon" @click="showToolbar = false" title="éš±è—æ§åˆ¶å°">â–¼ æ”¶èµ·</button>
                </div>
            </div>

            <div v-else class="toolbar-trigger" @click="showToolbar = true" title="é–‹å•Ÿè¬›å¸«æ§åˆ¶å°">
                âš™ï¸
            </div>

        </div>

        <div v-else class="student-wrapper">
            <div class="student-container">
                <h2 style="text-align: center; color: #333; margin-top:0; margin-bottom: 20px;">
                    ğŸ“ è«‹é‡å°ä»¥ä¸‹é …ç›®æä¾›å›æ‡‰
                </h2>

                <div v-if="zones.length > 0">
                    <div v-for="(z, idx) in zones" :key="idx" class="zone-card">
                        <h3>
                            {{ z.name }}
                            <span class="zone-hint">({{ getLocationLabel(z.pos) }})</span>
                        </h3>
                        <div class="input-row">
                            <input 
                                type="text" 
                                v-model="z.draftText" 
                                :placeholder="'è¼¸å…¥ã€Œ' + z.name + 'ã€çš„æƒ³æ³•...'"
                                @keydown.enter="sendZoneNote(z)"
                            >
                            <button class="btn btn-primary" @click="sendZoneNote(z)">é€å‡º</button>
                        </div>
                    </div>
                </div>

                <div v-else class="zone-card" style="border-left-color: #999;">
                    <h3>è‡ªç”±ç™¼è¨€å€</h3>
                    <div class="input-row">
                        <input 
                            type="text" 
                            v-model="freeText" 
                            placeholder="è«‹è¼¸å…¥æ‚¨çš„æƒ³æ³•..."
                            @keydown.enter="sendFreeNote"
                        >
                        <button class="btn btn-primary" @click="sendFreeNote">é€å‡º</button>
                    </div>
                </div>

                <hr style="margin: 30px 0; border: 0; border-top: 1px dashed #ccc;">

                <div class="my-list-section">
                    <h3 style="color:#555; margin-top:0;">æˆ‘çš„ç´€éŒ„ ({{ myNotes.length }})</h3>
                    <div v-if="myNotes.length > 0">
                        <div v-for="note in myNotes" :key="note.key" class="my-item">
                            <div style="flex:1; padding-right:10px;">
                                <div>
                                    <span v-if="note.zoneName" class="note-tag">{{ note.zoneName }}</span>
                                    <span style="font-size:1.1rem; color:#333;">{{ note.text }}</span>
                                </div>
                                <div style="font-size:0.8rem; color:#999; margin-top:5px;">
                                    {{ new Date(note.timestamp).toLocaleTimeString() }}
                                </div>
                            </div>
                            <div style="white-space:nowrap;">
                                <button class="btn btn-secondary" @click="openEditModal(note)">ä¿®æ”¹</button>
                                <button class="btn btn-danger" @click="deleteNote(note.key)">åˆªé™¤</button>
                            </div>
                        </div>
                    </div>
                    <div v-else style="text-align:center; color:#999; font-style:italic; padding:20px;">
                        å°šç„¡å…§å®¹...
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showZoneModal" class="modal-overlay">
            <div class="modal-box">
                <h3>åˆ†å€èˆ‡è½é»è¨­å®š</h3>
                <p style="color:#666; font-size:0.9rem;">è¨­å®šåˆ†é¡åç¨±ï¼Œä¸¦æŒ‡å®šå­¸å“¡é€å‡ºå¾Œä¾¿åˆ©è²¼æœƒè‡ªå‹•é£›åˆ°çš„ä½ç½®ã€‚</p>
                
                <div v-for="(z, idx) in tempZones" :key="idx" class="zone-row">
                    <input type="text" v-model="z.name" placeholder="åˆ†é¡åç¨± (ä¾‹: çŸ¥è­˜)">
                    <select v-model="z.pos">
                        <option value="TL">â†– å·¦ä¸Š</option>
                        <option value="TR">â†— å³ä¸Š</option>
                        <option value="BL">â†™ å·¦ä¸‹</option>
                        <option value="BR">â†˜ å³ä¸‹</option>
                        <option value="T">â†‘ ä¸Šæ–¹</option>
                        <option value="B">â†“ ä¸‹æ–¹</option>
                        <option value="L">â† å·¦å´</option>
                        <option value="R">â†’ å³å´</option>
                        <option value="C">â— ä¸­é–“</option>
                    </select>
                    <button class="btn btn-danger" @click="removeTempZone(idx)">âœ•</button>
                </div>
                
                <button class="btn btn-success" @click="addTempZone" style="width:100%; margin-top:10px;">ï¼‹ æ–°å¢åˆ†é¡</button>

                <div style="margin-top: 20px; text-align: right; border-top: 1px solid #eee; padding-top: 15px;">
                    <button class="btn btn-secondary" @click="showZoneModal = false">å–æ¶ˆ</button>
                    <button class="btn btn-primary" @click="saveZones">å„²å­˜è¨­å®š</button>
                </div>
            </div>
        </div>

        <div v-if="showEditModal" class="modal-overlay">
            <div class="edit-modal">
                <h3>âœï¸ ä¿®æ”¹å›æ‡‰</h3>
                <div style="margin-bottom:15px;">
                    <label style="display:block; color:#666; margin-bottom:5px;">åˆ†é¡ï¼š{{ editingNote.zoneName || 'è‡ªç”±å€' }}</label>
                    <input type="text" v-model="editingNote.text" class="input-box" style="width:100%;">
                </div>
                <div style="text-align:right;">
                    <button class="btn btn-secondary" @click="showEditModal = false">å–æ¶ˆ</button>
                    <button class="btn btn-primary" @click="confirmEdit">æ›´æ–°</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue;

        const firebaseConfig = {
            apiKey: "AIzaSyDUPGhkiJgxeYDYHqEaXCYvKh2vdTGqypw",
            authDomain: "class-discussion-01.firebaseapp.com",
            databaseURL: "https://class-discussion-01-default-rtdb.firebaseio.com",
            projectId: "class-discussion-01",
            storageBucket: "class-discussion-01.firebasestorage.app",
            messagingSenderId: "724687365020",
            appId: "1:724687365020:web:380b5d85872dc2d9b85e59",
            measurementId: "G-XYN5JV48T7"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        createApp({
            data() {
                return {
                    isLoading: true,
                    isTeacher: false,
                    studentId: '',
                    
                    // è³‡æ–™
                    notes: [],
                    bgImage: '',
                    
                    // åˆ†å€è¨­å®š
                    zones: [],
                    freeText: '', 
                    
                    // UI æ§åˆ¶
                    showToolbar: false, // é è¨­éš±è—æ§åˆ¶å°ï¼Œåªé¡¯ç¤º icon
                    showEditModal: false,
                    editingNote: { key: '', text: '', zoneName: '' },
                    showZoneModal: false,
                    tempZones: [],
                    
                    draggingNote: null,
                    dragOffsetX: 0,
                    dragOffsetY: 0,
                }
            },
            computed: {
                myNotes() {
                    return this.notes.filter(n => n.studentId === this.studentId).reverse();
                }
            },
            mounted() {
                const urlParams = new URLSearchParams(window.location.search);
                this.isTeacher = urlParams.get('role') === 'teacher';

                if (!this.isTeacher) {
                    let storedId = localStorage.getItem('class_student_id_v3');
                    if (!storedId) {
                        storedId = 'std_' + Math.random().toString(36).substr(2, 9);
                        localStorage.setItem('class_student_id_v3', storedId);
                    }
                    this.studentId = storedId;
                    document.body.style.overflow = "auto";
                } else {
                    window.addEventListener('mousemove', this.onDrag);
                    window.addEventListener('mouseup', this.stopDrag);
                }

                // ç›£è½ä¾¿åˆ©è²¼
                db.ref('board/notes').on('value', snapshot => {
                    const val = snapshot.val();
                    this.notes = val ? Object.keys(val).map(key => ({...val[key], key})) : [];
                    this.isLoading = false;
                });

                db.ref('board/background').on('value', s => this.bgImage = s.val() || '');
                
                db.ref('board/settings/zones').on('value', s => {
                    const data = s.val() || [];
                    this.zones = data.map(z => ({ ...z, draftText: '' }));
                });
            },
            methods: {
                // å­¸å“¡æ–¹æ³•
                sendZoneNote(zone) {
                    if (!zone.draftText.trim()) return;
                    const pos = this.calcPosition(zone.pos);
                    db.ref('board/notes').push({
                        text: zone.draftText,
                        studentId: this.studentId,
                        zoneName: zone.name,
                        x: pos.x, y: pos.y,
                        timestamp: Date.now()
                    });
                    zone.draftText = '';
                },
                sendFreeNote() {
                    if (!this.freeText.trim()) return;
                    db.ref('board/notes').push({
                        text: this.freeText,
                        studentId: this.studentId,
                        zoneName: '',
                        x: 50 + Math.random() * 200, y: 100 + Math.random() * 200,
                        timestamp: Date.now()
                    });
                    this.freeText = '';
                },
                openEditModal(note) {
                    this.editingNote = { ...note };
                    this.showEditModal = true;
                },
                confirmEdit() {
                    const { key, text } = this.editingNote;
                    db.ref('board/notes/' + key).update({ text });
                    this.showEditModal = false;
                },

                // åº§æ¨™è¨ˆç®—
                calcPosition(posCode) {
                    const W = 1200; const H = 800; const padding = 100;
                    const rand = () => (Math.random() - 0.5) * 60;
                    let x = W/2, y = H/2;
                    switch(posCode) {
                        case 'TL': x = padding; y = padding; break;
                        case 'TR': x = W-padding-150; y = padding; break;
                        case 'BL': x = padding; y = H-padding-100; break;
                        case 'BR': x = W-padding-150; y = H-padding-100; break;
                        case 'T':  x = W/2; y = padding; break;
                        case 'B':  x = W/2; y = H-padding-100; break;
                        case 'L':  x = padding; y = H/2; break;
                        case 'R':  x = W-padding-150; y = H/2; break;
                        case 'C':  x = W/2; y = H/2; break;
                    }
                    return { x: x + rand(), y: y + rand() };
                },
                getLocationLabel(code) {
                    const map = {
                        'TL': 'â†– å·¦ä¸Š', 'T': 'â†‘ ä¸Šæ–¹', 'TR': 'â†— å³ä¸Š',
                        'L': 'â† å·¦å´', 'C': 'â— ä¸­é–“', 'R': 'â†’ å³å´',
                        'BL': 'â†™ å·¦ä¸‹', 'B': 'â†“ ä¸‹æ–¹', 'BR': 'â†˜ å³ä¸‹'
                    };
                    return map[code] || '';
                },

                // è¬›å¸«æ–¹æ³•
                addTempZone() { this.tempZones.push({ name: '', pos: 'C' }); },
                removeTempZone(idx) { this.tempZones.splice(idx, 1); },
                saveZones() {
                    const finalZones = this.tempZones.filter(z => z.name.trim() !== '');
                    db.ref('board/settings/zones').set(finalZones);
                    this.showZoneModal = false;
                },
                handleBgUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    if (file.size > 2 * 1024 * 1024) { alert('åœ–æª”éå¤§'); return; }
                    const reader = new FileReader();
                    reader.onload = (e) => db.ref('board/background').set(e.target.result);
                    reader.readAsDataURL(file);
                },
                startDrag(e, note) {
                    if (!this.isTeacher) return;
                    this.draggingNote = note;
                    this.dragOffsetX = e.clientX - note.x;
                    this.dragOffsetY = e.clientY - note.y;
                },
                onDrag(e) {
                    if (this.draggingNote) {
                        e.preventDefault();
                        this.draggingNote.x = e.clientX - this.dragOffsetX;
                        this.draggingNote.y = e.clientY - this.dragOffsetY;
                    }
                },
                stopDrag() {
                    if (this.draggingNote) {
                        const { key, x, y } = this.draggingNote;
                        db.ref(`board/notes/${key}`).update({ x, y });
                        this.draggingNote = null;
                    }
                },
                deleteNote(key) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) db.ref(`board/notes/${key}`).remove(); },
                clearBoard() { if(confirm('ç¢ºå®šæ¸…ç©ºï¼Ÿ')) db.ref('board/notes').remove(); },
                getColorClass(key) { return `color-${(key.charCodeAt(key.length-1)%4)+1}`; },
            },
            watch: {
                showZoneModal(val) { if (val) this.tempZones = JSON.parse(JSON.stringify(this.zones)); }
            }
        }).mount('#app');
    </script>
</body>
</html>