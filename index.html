<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’å‹•ä¾¿åˆ©è²¼ç™½æ¿</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        body { font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; background-color: #333; margin: 0; padding: 0; overflow: hidden; }
        
        /* é€šç”¨æŒ‰éˆ• */
        .btn { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-size: 1rem; margin: 5px; }
        .btn-primary { background: #1976d2; color: white; }
        .btn-danger { background: #d32f2f; color: white; }
        .btn-upload { background: #4caf50; color: white; display: inline-block; cursor: pointer; }
        
        /* --- å­¸å“¡ç«¯æ¨£å¼ --- */
        .student-container { 
            max-width: 600px; margin: 50px auto; background: #f0f2f5; 
            padding: 30px; border-radius: 15px; min-height: 80vh;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .input-area { display: flex; gap: 10px; margin-bottom: 20px; }
        .input-box { flex: 1; padding: 15px; font-size: 1.1rem; border: 2px solid #ddd; border-radius: 8px; outline: none; }
        .input-box:focus { border-color: #1976d2; }
        .my-list h3 { border-bottom: 2px solid #ddd; padding-bottom: 10px; color: #555; }
        .my-item { 
            background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 8px; 
            border-left: 5px solid #ffeb3b; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
        }
        .waiting-text { text-align: center; color: #777; margin-top: 50px; font-style: italic; }

        /* --- è¬›å¸«ç«¯æ¨£å¼ (ç™½æ¿) --- */
        .teacher-board { 
            position: relative; width: 100vw; height: 100vh; overflow: hidden; 
            background-color: #e0e0e0; 
            background-size: contain; 
            background-repeat: no-repeat;
            background-position: center;
        }
        .toolbar {
            position: fixed; top: 10px; left: 10px; right: 10px;
            background: rgba(255,255,255,0.9); padding: 10px; border-radius: 8px;
            z-index: 1000; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        /* ä¾¿åˆ©è²¼æ¨£å¼ */
        .sticky-note {
            position: absolute;
            width: 180px;
            min-height: 100px;
            background: #ffeb3b; /* ç¶“å…¸ä¾¿åˆ©è²¼é»ƒ */
            padding: 15px;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
            font-size: 1.1rem;
            line-height: 1.4;
            cursor: grab;
            transform: rotate(-1deg); /* ç¨å¾®æ­ªä¸€é»æ¯”è¼ƒåƒä¾¿åˆ©è²¼ */
            transition: box-shadow 0.2s, transform 0.1s;
            user-select: none; /* é¿å…æ‹–æ›³æ™‚é¸å–æ–‡å­— */
            border-radius: 2px 2px 15px 2px; /* å³ä¸‹è§’æ²èµ·æ•ˆæœ */
            word-wrap: break-word;
        }
        .sticky-note:active { cursor: grabbing; box-shadow: 5px 10px 20px rgba(0,0,0,0.3); transform: scale(1.05); z-index: 999; }
        .note-close { 
            position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; 
            background: red; color: white; border-radius: 50%; text-align: center; 
            line-height: 22px; cursor: pointer; font-size: 14px; display: none;
        }
        .sticky-note:hover .note-close { display: block; }

        /* é¡è‰²è®ŠåŒ– */
        .color-1 { background: #ffeb3b; } /* é»ƒ */
        .color-2 { background: #81d4fa; } /* è— */
        .color-3 { background: #a5d6a7; } /* ç¶  */
        .color-4 { background: #ef9a9a; } /* ç´… */

    </style>
</head>
<body>
    <div id="app">
        <div v-if="isLoading" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); color:white; display:flex; justify-content:center; align-items:center; z-index:9999;">
            è¼‰å…¥ä¸­...
        </div>

        <div v-if="isTeacher" class="teacher-board" :style="{ backgroundImage: 'url(' + bgImage + ')' }">
            
            <div class="toolbar">
                <div>
                    <strong>è¬›å¸«æ§åˆ¶å°</strong> | 
                    ä¾¿åˆ©è²¼æ•¸é‡: {{ notes.length }}
                </div>
                <div>
                    <label class="btn btn-upload">
                        æ›´æ›èƒŒæ™¯åœ–
                        <input type="file" accept="image/*" style="display: none;" @change="handleBgUpload">
                    </label>
                    <button class="btn btn-danger" @click="clearBoard">æ¸…ç©ºç•«å¸ƒ</button>
                </div>
            </div>

            <div v-for="note in notes" 
                 :key="note.key"
                 class="sticky-note"
                 :class="getColorClass(note.key)"
                 :style="{ left: note.x + 'px', top: note.y + 'px' }"
                 @mousedown="startDrag($event, note)"
            >
                {{ note.text }}
                <div class="note-close" @click.stop="deleteNote(note.key)">âœ•</div>
            </div>

        </div>

        <div v-else class="student-container">
            <h2 style="text-align: center; color: #333;">ğŸ’¡ æƒ³æ³•æä¾›å€</h2>
            <p style="text-align: center; color: #666; margin-bottom: 30px;">
                è«‹è¼¸å…¥æ‚¨çš„æƒ³æ³•ï¼Œé€å‡ºå¾Œè¬›å¸«æœƒå³æ™‚æ”¶åˆ°ã€‚<br>
                <small>(æ‚¨åªæœƒçœ‹åˆ°è‡ªå·±çš„ç´€éŒ„ï¼Œä¸æœƒå—ä»–äººå½±éŸ¿)</small>
            </p>

            <div class="input-area">
                <input 
                    type="text" 
                    class="input-box" 
                    v-model="inputText" 
                    placeholder="è¼¸å…¥æ‚¨çš„è«–é»æˆ–ç­”æ¡ˆ..." 
                    @keydown.enter="sendNote"
                >
                <button class="btn btn-primary" @click="sendNote">é€å‡º</button>
            </div>

            <div class="my-list">
                <h3>æˆ‘çš„ç´€éŒ„</h3>
                <div v-if="myNotes.length > 0">
                    <div v-for="note in myNotes" :key="note.key" class="my-item">
                        <span>{{ note.text }}</span>
                        <small style="color:#999">å·²å‚³é€</small>
                    </div>
                </div>
                <div v-else class="waiting-text">
                    å°šç„¡å…§å®¹ï¼Œè«‹é–‹å§‹è¼¸å…¥...
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        // Firebase è¨­å®š (ç¶­æŒä½ çš„è¨­å®š)
        const firebaseConfig = {
            apiKey: "AIzaSyDUPGhkiJgxeYDYHqEaXCYvKh2vdTGqypw",
            authDomain: "class-discussion-01.firebaseapp.com",
            databaseURL: "https://class-discussion-01-default-rtdb.firebaseio.com",
            projectId: "class-discussion-01",
            storageBucket: "class-discussion-01.firebasestorage.app",
            messagingSenderId: "724687365020",
            appId: "1:724687365020:web:380b5d85872dc2d9b85e59",
            measurementId: "G-XYN5JV48T7"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        createApp({
            data() {
                return {
                    isLoading: true,
                    isTeacher: false,
                    studentId: '', // ç”¨ä¾†è­˜åˆ¥æ˜¯å“ªå€‹å­¸ç”Ÿ (å­˜åœ¨ localStorage)
                    
                    // è³‡æ–™
                    notes: [], // æ‰€æœ‰ä¾¿åˆ©è²¼
                    inputText: '',
                    bgImage: '', // èƒŒæ™¯åœ– Base64
                    
                    // æ‹–æ›³ç›¸é—œè®Šæ•¸
                    draggingNote: null,
                    dragOffsetX: 0,
                    dragOffsetY: 0,
                }
            },
            computed: {
                // å­¸å“¡åªçœ‹å¾—åˆ°è‡ªå·±çš„
                myNotes() {
                    return this.notes.filter(n => n.studentId === this.studentId).reverse();
                }
            },
            mounted() {
                const urlParams = new URLSearchParams(window.location.search);
                this.isTeacher = urlParams.get('role') === 'teacher';

                // åˆå§‹åŒ–å­¸ç”Ÿ ID (å¦‚æœæ²’æœ‰å°±ç”¢ç”Ÿä¸€å€‹éš¨æ©Ÿçš„)
                if (!this.isTeacher) {
                    let storedId = localStorage.getItem('class_student_id');
                    if (!storedId) {
                        storedId = 'std_' + Math.random().toString(36).substr(2, 9);
                        localStorage.setItem('class_student_id', storedId);
                    }
                    this.studentId = storedId;
                    
                    // ç‚ºäº†æ–¹ä¾¿ï¼Œå­¸å“¡ç«¯æŠŠ body èƒŒæ™¯æ”¹å›ç™½è‰²ç³»
                    document.body.style.backgroundColor = "#f0f2f5";
                    document.body.style.overflow = "auto";
                }

                // ç›£è½ä¾¿åˆ©è²¼è³‡æ–™
                db.ref('board/notes').on('value', snapshot => {
                    const val = snapshot.val();
                    this.notes = val ? Object.keys(val).map(key => ({...val[key], key})) : [];
                    this.isLoading = false;
                });

                // ç›£è½èƒŒæ™¯åœ–
                db.ref('board/background').on('value', snapshot => {
                    this.bgImage = snapshot.val() || '';
                });

                // å…¨åŸŸæ»‘é¼ äº‹ä»¶ (è™•ç†æ‹–æ›³çµæŸ)
                if (this.isTeacher) {
                    window.addEventListener('mousemove', this.onDrag);
                    window.addEventListener('mouseup', this.stopDrag);
                }
            },
            methods: {
                // --- å­¸å“¡åŠŸèƒ½ ---
                sendNote() {
                    if (!this.inputText.trim()) return;
                    
                    // é è¨­ä½ç½®åœ¨ç•«é¢å·¦ä¸Šè§’éš¨æ©Ÿä¸€é»ï¼Œé¿å…å…¨éƒ¨ç–Šåœ¨ä¸€èµ·
                    const randomX = 50 + Math.random() * 200;
                    const randomY = 100 + Math.random() * 200;

                    const newNote = {
                        text: this.inputText,
                        studentId: this.studentId,
                        x: randomX,
                        y: randomY,
                        timestamp: Date.now()
                    };

                    db.ref('board/notes').push(newNote);
                    this.inputText = '';
                },

                // --- è¬›å¸«åŠŸèƒ½ ---
                
                // 1. ä¸Šå‚³èƒŒæ™¯åœ– (è½‰ Base64 å­˜å…¥ DB)
                handleBgUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    // é™åˆ¶åœ–ç‰‡å¤§å°é¿å… Firebase çˆ†æ‰ (ç°¡å–®å‰ç«¯é™åˆ¶)
                    if (file.size > 2 * 1024 * 1024) {
                        alert('åœ–ç‰‡å¤ªå¤§å›‰ï¼Œè«‹é¸æ“‡å°æ–¼ 2MB çš„åœ–ç‰‡');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        db.ref('board/background').set(e.target.result);
                    };
                    reader.readAsDataURL(file);
                },

                // 2. æ‹–æ›³é‚è¼¯
                startDrag(e, note) {
                    if (!this.isTeacher) return;
                    this.draggingNote = note;
                    // è¨ˆç®—æ»‘é¼ é»æ“Šé»èˆ‡ç‰©ä»¶å·¦ä¸Šè§’çš„å·®è·
                    this.dragOffsetX = e.clientX - note.x;
                    this.dragOffsetY = e.clientY - note.y;
                },
                onDrag(e) {
                    if (this.draggingNote) {
                        e.preventDefault();
                        // æš«æ™‚æ›´æ–°æœ¬åœ°æ•¸æ“šä»¥é”åˆ°æµæš¢å‹•ç•«æ•ˆæœ
                        this.draggingNote.x = e.clientX - this.dragOffsetX;
                        this.draggingNote.y = e.clientY - this.dragOffsetY;
                    }
                },
                stopDrag() {
                    if (this.draggingNote) {
                        // æ‹–æ›³çµæŸï¼Œå°‡æœ€çµ‚åº§æ¨™å¯«å…¥ Firebase
                        const { key, x, y } = this.draggingNote;
                        db.ref(`board/notes/${key}`).update({ x, y });
                        this.draggingNote = null;
                    }
                },

                // 3. åˆªé™¤èˆ‡æ¸…ç©º
                deleteNote(key) {
                    if(confirm('ç¢ºå®šåˆªé™¤é€™å¼µä¾¿åˆ©è²¼ï¼Ÿ')) {
                        db.ref(`board/notes/${key}`).remove();
                    }
                },
                clearBoard() {
                    if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ä¾¿åˆ©è²¼å—ï¼Ÿ(èƒŒæ™¯åœ–æœƒä¿ç•™)')) {
                        db.ref('board/notes').remove();
                    }
                },

                // è¼”åŠ©ï¼šæ ¹æ“š key ç”¢ç”Ÿå½éš¨æ©Ÿé¡è‰²
                getColorClass(key) {
                    const charCode = key.charCodeAt(key.length - 1);
                    const mod = charCode % 4;
                    return `color-${mod + 1}`;
                }
            }
        }).mount('#app');
    </script>
</body>
</html>