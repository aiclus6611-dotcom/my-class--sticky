<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çµæ§‹åŒ–äº’å‹•ç™½æ¿ (ç•«å¸ƒç¸®æ”¾ç‰ˆ)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        body { font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; background-color: #333; margin: 0; padding: 0; overflow: hidden; }
        
        /* --- é€šç”¨å…ƒä»¶ --- */
        .btn { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-size: 1rem; margin: 5px; transition: 0.2s; white-space: nowrap;}
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background: #1976d2; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-danger { background: #d32f2f; color: white; }
        .btn-secondary { background: #757575; color: white; }
        .btn-upload { background: #ff9800; color: white; display: inline-block; cursor: pointer; padding: 8px 16px; border-radius: 4px; margin: 5px;}
        .btn-icon { background: transparent; color: #ccc; font-size: 1.2rem; padding: 5px 10px; }
        .btn-icon:hover { color: white; background: rgba(255,255,255,0.1); }
        
        input, select { padding: 10px; border-radius: 4px; border: 1px solid #ccc; font-size: 1rem; box-sizing: border-box; }

        /* --- å­¸å“¡ç«¯æ¨£å¼ --- */
        .student-wrapper {
            background-color: #f0f2f5; height: 100vh; overflow-y: auto; padding: 20px; box-sizing: border-box;
        }
        .student-container { 
            max-width: 600px; margin: 0 auto; padding-bottom: 50px;
        }
        .zone-card {
            background: white; padding: 20px; border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px;
            border-left: 6px solid #1976d2; 
        }
        .zone-card h3 { margin: 0 0 10px 0; color: #333; display: flex; justify-content: space-between; align-items: center; }
        .zone-hint { font-size: 0.85rem; color: #888; font-weight: normal; }
        .input-row { display: flex; gap: 10px; }
        .input-row input { flex: 1; }
        .zone-card:nth-child(4n+1) { border-left-color: #fbc02d; }
        .zone-card:nth-child(4n+2) { border-left-color: #42a5f5; }
        .zone-card:nth-child(4n+3) { border-left-color: #66bb6a; }
        .zone-card:nth-child(4n+4) { border-left-color: #ef5350; }

        .my-list-section { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .my-item { 
            background: #fafafa; padding: 15px; margin-bottom: 10px; border-radius: 8px; 
            border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
        }
        .note-tag {
            display: inline-block; background: #e3f2fd; color: #1565c0;
            font-size: 0.8rem; padding: 2px 8px; border-radius: 4px; 
            margin-bottom: 4px; font-weight: bold; margin-right: 5px;
        }

        /* --- è¬›å¸«ç«¯æ¨£å¼ (æ–°æ¶æ§‹ï¼šç•«å¸ƒç¸®æ”¾) --- */
        .teacher-viewport {
            width: 100vw; height: 100vh; 
            overflow: hidden; /* éš±è—æ²è»¸ï¼Œæ”¹ç”¨ transform ç§»å‹• */
            background-color: #333; /* è¦–çª—å¤–çš„é¡è‰² */
            position: relative;
            cursor: grab; /* é è¨­æ‰‹å‹ï¼Œè¡¨ç¤ºå¯æ‹–æ›³ç•«å¸ƒ */
        }
        .teacher-viewport:active { cursor: grabbing; }

        /* é€™æ˜¯çœŸæ­£çš„ã€Œç´™ã€ï¼Œæ‰€æœ‰æ±è¥¿éƒ½åœ¨é€™ä¸Šé¢ */
        .canvas-layer {
            position: absolute;
            transform-origin: 0 0; /* ç¸®æ”¾åŸé»è¨­ç‚ºå·¦ä¸Šè§’ */
            background-color: #e0e0e0; /* æ²’åœ–æ™‚çš„ç™½æ¿é¡è‰² */
            box-shadow: 0 0 50px rgba(0,0,0,0.5); /* è®“ç•«å¸ƒæœ‰é»ç«‹é«”æ„Ÿ */
            transition: transform 0.05s linear; /* è®“æ‹–æ›³ç¸®æ”¾ç¨å¾®å¹³æ»‘ä¸€é»é» */
        }

        /* èƒŒæ™¯åœ– */
        .bg-img {
            width: 100%; height: 100%;
            object-fit: contain; /* ç¢ºä¿åœ–ç‰‡ä¸è®Šå½¢ */
            pointer-events: none; /* è®“æ»‘é¼ å¯ä»¥ç›´æ¥é»ç©¿åœ–ç‰‡å»æ‹–æ›³ç•«å¸ƒ */
            display: block;
        }

        /* è¬›å¸«æ§åˆ¶å° */
        .toolbar-trigger {
            position: fixed; bottom: 20px; right: 20px;
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(0,0,0,0.4); color: white;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; cursor: pointer; z-index: 2000;
            transition: 0.3s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .toolbar-trigger:hover { background: rgba(0,0,0,0.8); transform: scale(1.1); }

        .toolbar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(0, 0, 0, 0.9); 
            padding: 15px 20px; 
            z-index: 2001; 
            display: flex; justify-content: space-between; align-items: center;
            color: white;
            animation: slideUp 0.3s ease-out;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* ä¾¿åˆ©è²¼æ¨£å¼ */
        .sticky-note {
            position: absolute; width: 180px; min-height: 100px;
            background: #ffeb3b; padding: 15px;
            box-shadow: 2px 5px 15px rgba(0,0,0,0.3);
            font-size: 1.1rem; line-height: 1.4;
            transform: rotate(-1deg);
            border-radius: 2px 2px 15px 2px; word-wrap: break-word; z-index: 100;
            user-select: none; 
            cursor: move; /* ä¾¿åˆ©è²¼ä¸Šé¡¯ç¤ºç§»å‹•æ¸¸æ¨™ */
        }
        /* é¿å…èˆ‡ç•«å¸ƒæ‹–æ›³è¡çªï¼Œéœ€è¦åœæ­¢å†’æ³¡ */
        .sticky-note:active { transform: scale(1.05); z-index: 999; cursor: grabbing; }

        .sticky-tag {
            display: inline-block; background: rgba(0,0,0,0.1); 
            font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; 
            margin-bottom: 5px; color: #444; font-weight: bold;
        }
        .note-close { 
            position: absolute; top: -10px; right: -10px; width: 24px; height: 24px; 
            background: red; color: white; border-radius: 50%; text-align: center; 
            line-height: 22px; cursor: pointer; font-size: 14px; display: none; z-index: 101;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .sticky-note:hover .note-close { display: block; }
        .color-1 { background: #fff9c4; } 
        .color-2 { background: #b3e5fc; } 
        .color-3 { background: #c8e6c9; } 
        .color-4 { background: #ffcdd2; } 

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 3000;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-box {
            background: white; padding: 25px; border-radius: 10px; width: 500px; max-width: 90%;
            max-height: 80vh; overflow-y: auto;
        }
        .zone-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .zone-row input { flex: 1; }
        .edit-modal { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; }
    </style>
</head>
<body>
    <div id="app">
        <div v-if="isLoading" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); color:white; display:flex; justify-content:center; align-items:center; z-index:9999;">
            è¼‰å…¥ä¸­...
        </div>

        <div v-if="isTeacher" class="teacher-viewport" 
             @mousedown.self="startPan" 
             @wheel.prevent="handleZoom">
            
            <div class="canvas-layer" :style="canvasStyle">
                
                <img v-if="bgImage" :src="bgImage" class="bg-img" @load="onImgLoad">
                <div v-else style="width: 100%; height: 100%;"></div>

                <div v-for="note in notes" 
                     :key="note.key"
                     class="sticky-note"
                     :class="getColorClass(note.key)"
                     :style="{ left: note.x + '%', top: note.y + '%' }"
                     @mousedown.stop="startDragNote($event, note)"
                >
                    <div v-if="note.zoneName" class="sticky-tag">{{ note.zoneName }}</div>
                    {{ note.text }}
                    <div class="note-close" @click.stop="deleteNote(note.key)">âœ•</div>
                </div>
            </div>

            <div v-if="showToolbar" class="toolbar">
                <div style="display:flex; gap:10px; align-items:center;">
                    <strong style="font-size:1.1rem;">è¬›å¸«æ§åˆ¶å°</strong>
                    <span style="color:#bbb; font-size:0.9rem;">(æ»‘é¼ æ»¾è¼ªå¯ç¸®æ”¾)</span>
                </div>
                
                <div style="display:flex; align-items:center; gap: 5px;">
                    <button class="btn btn-secondary" @click="resetView">ğŸ” ç½®ä¸­/é‚„åŸ</button>
                    <button class="btn btn-primary" @click="showZoneModal = true">âš™ï¸ åˆ†å€è¨­å®š</button>
                    <label class="btn btn-upload">
                        ğŸ–¼ï¸ æ›´æ›èƒŒæ™¯
                        <input type="file" accept="image/*" style="display: none;" @change="handleBgUpload">
                    </label>
                    <button v-if="bgImage" class="btn btn-danger" @click="removeBackground">âœ• ç§»é™¤èƒŒæ™¯</button>
                    <button class="btn btn-danger" @click="clearBoard">ğŸ—‘ï¸ æ¸…ç©ºè²¼ç´™</button>
                    <div style="width:1px; height:25px; background:#555; margin:0 10px;"></div>
                    <button class="btn btn-icon" @click="showToolbar = false" title="éš±è—">â–¼</button>
                </div>
            </div>
            <div v-else class="toolbar-trigger" @click="showToolbar = true" title="é–‹å•Ÿè¨­å®š">âš™ï¸</div>
        </div>

        <div v-else class="student-wrapper">
            <div class="student-container">
                <h2 style="text-align: center; color: #333; margin-top:0; margin-bottom: 20px;">
                    ğŸ“ è«‹é‡å°ä»¥ä¸‹é …ç›®æä¾›å›æ‡‰
                </h2>
                <div v-if="zones.length > 0">
                    <div v-for="(z, idx) in zones" :key="idx" class="zone-card">
                        <h3>{{ z.name }} <span class="zone-hint">({{ getLocationLabel(z.pos) }})</span></h3>
                        <div class="input-row">
                            <input type="text" v-model="z.draftText" :placeholder="'è«‹è¼¸å…¥é—œæ–¼ã€Œ' + z.name + 'ã€' + (promptSuffix || 'çš„æƒ³æ³•') + '...'" @keydown.enter="sendZoneNote(z)">
                            <button class="btn btn-primary" @click="sendZoneNote(z)">é€å‡º</button>
                        </div>
                    </div>
                </div>
                <div v-else class="zone-card" style="border-left-color: #999;">
                    <h3>è‡ªç”±ç™¼è¨€å€</h3>
                    <div class="input-row">
                        <input type="text" v-model="freeText" placeholder="è«‹è¼¸å…¥æ‚¨çš„æƒ³æ³•..." @keydown.enter="sendFreeNote">
                        <button class="btn btn-primary" @click="sendFreeNote">é€å‡º</button>
                    </div>
                </div>
                <hr style="margin: 30px 0; border: 0; border-top: 1px dashed #ccc;">
                <div class="my-list-section">
                    <h3 style="color:#555; margin-top:0;">æˆ‘çš„ç´€éŒ„ ({{ myNotes.length }})</h3>
                    <div v-if="myNotes.length > 0">
                        <div v-for="note in myNotes" :key="note.key" class="my-item">
                            <div style="flex:1; padding-right:10px;">
                                <div><span v-if="note.zoneName" class="note-tag">{{ note.zoneName }}</span><span style="font-size:1.1rem; color:#333;">{{ note.text }}</span></div>
                                <div style="font-size:0.8rem; color:#999; margin-top:5px;">{{ new Date(note.timestamp).toLocaleTimeString() }}</div>
                            </div>
                            <div style="white-space:nowrap;">
                                <button class="btn btn-secondary" @click="openEditModal(note)">ä¿®æ”¹</button>
                                <button class="btn btn-danger" @click="deleteNote(note.key)">åˆªé™¤</button>
                            </div>
                        </div>
                    </div>
                    <div v-else style="text-align:center; color:#999; font-style:italic; padding:20px;">å°šç„¡å…§å®¹...</div>
                </div>
            </div>
        </div>

        <div v-if="showZoneModal" class="modal-overlay">
            <div class="modal-box">
                <h3 style="margin-top:0;">åˆ†å€èˆ‡æç¤ºè¨­å®š</h3>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #eee;">
                    <label style="font-weight:bold; display:block; margin-bottom:5px;">å­¸å“¡è¼¸å…¥æ¡†æç¤ºçµå°¾ï¼š</label>
                    <input type="text" v-model="tempSuffix" placeholder="ä¾‹å¦‚ï¼šçš„æƒ³æ³•ã€çš„æ¢ä»¶..." style="width:100%; padding:8px;">
                </div>
                <div v-for="(z, idx) in tempZones" :key="idx" class="zone-row">
                    <input type="text" v-model="z.name" placeholder="åˆ†é¡åç¨±">
                    <select v-model="z.pos">
                        <option value="TL">â†– å·¦ä¸Š</option><option value="TR">â†— å³ä¸Š</option><option value="BL">â†™ å·¦ä¸‹</option><option value="BR">â†˜ å³ä¸‹</option>
                        <option value="T">â†‘ ä¸Šæ–¹</option><option value="B">â†“ ä¸‹æ–¹</option><option value="L">â† å·¦å´</option><option value="R">â†’ å³å´</option><option value="C">â— ä¸­é–“</option>
                    </select>
                    <button class="btn btn-danger" @click="removeTempZone(idx)">âœ•</button>
                </div>
                <button class="btn btn-success" @click="addTempZone" style="width:100%; margin-top:10px;">ï¼‹ æ–°å¢åˆ†é¡</button>
                <div style="margin-top: 20px; text-align: right; border-top: 1px solid #eee; padding-top: 15px;">
                    <button class="btn btn-secondary" @click="showZoneModal = false">å–æ¶ˆ</button>
                    <button class="btn btn-primary" @click="saveZones">å„²å­˜è¨­å®š</button>
                </div>
            </div>
        </div>
        <div v-if="showEditModal" class="modal-overlay">
            <div class="edit-modal">
                <h3>âœï¸ ä¿®æ”¹å›æ‡‰</h3>
                <input type="text" v-model="editingNote.text" class="input-box" style="width:100%; margin-bottom:15px;">
                <div style="text-align:right;">
                    <button class="btn btn-secondary" @click="showEditModal = false">å–æ¶ˆ</button>
                    <button class="btn btn-primary" @click="confirmEdit">æ›´æ–°</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        const firebaseConfig = {
            apiKey: "AIzaSyDUPGhkiJgxeYDYHqEaXCYvKh2vdTGqypw",
            authDomain: "class-discussion-01.firebaseapp.com",
            databaseURL: "https://class-discussion-01-default-rtdb.firebaseio.com",
            projectId: "class-discussion-01",
            storageBucket: "class-discussion-01.firebasestorage.app",
            messagingSenderId: "724687365020",
            appId: "1:724687365020:web:380b5d85872dc2d9b85e59",
            measurementId: "G-XYN5JV48T7"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        createApp({
            data() {
                return {
                    isLoading: true,
                    isTeacher: false,
                    studentId: '',
                    notes: [],
                    bgImage: '',
                    zones: [],
                    promptSuffix: 'çš„æƒ³æ³•',
                    freeText: '', 
                    showToolbar: false,
                    showEditModal: false,
                    editingNote: { key: '', text: '', zoneName: '' },
                    showZoneModal: false,
                    tempZones: [],
                    tempSuffix: '',

                    // === ç•«å¸ƒç³»çµ±è®Šæ•¸ ===
                    // é è¨­ç•«å¸ƒå¤§å° (ç„¡åœ–æ™‚ç”¨)
                    canvasW: 1280, 
                    canvasH: 720,
                    // è¦–çª—è®Šæ› (Transform)
                    scale: 1,
                    panning: false,
                    pointX: 0, 
                    pointY: 0,
                    startX: 0, 
                    startY: 0,

                    // æ‹–æ›³ä¾¿åˆ©è²¼è®Šæ•¸
                    draggingNote: null,
                    noteDragStartX: 0, // åˆå§‹æ»‘é¼  X
                    noteDragStartY: 0, // åˆå§‹æ»‘é¼  Y
                    noteInitialPercentX: 0, 
                    noteInitialPercentY: 0,
                }
            },
            computed: {
                myNotes() { return this.notes.filter(n => n.studentId === this.studentId).reverse(); },
                canvasStyle() {
                    return {
                        width: this.canvasW + 'px',
                        height: this.canvasH + 'px',
                        transform: `translate(${this.pointX}px, ${this.pointY}px) scale(${this.scale})`
                    }
                }
            },
            mounted() {
                const urlParams = new URLSearchParams(window.location.search);
                this.isTeacher = urlParams.get('role') === 'teacher';

                if (!this.isTeacher) {
                    let storedId = localStorage.getItem('class_student_id_v3');
                    if (!storedId) {
                        storedId = 'std_' + Math.random().toString(36).substr(2, 9);
                        localStorage.setItem('class_student_id_v3', storedId);
                    }
                    this.studentId = storedId;
                    document.body.style.overflow = "auto";
                } else {
                    // è¬›å¸«ç«¯ä¸éœ€è¦ overflow (ç”± transform è™•ç†)
                }

                db.ref('board/notes').on('value', snapshot => {
                    const val = snapshot.val();
                    this.notes = val ? Object.keys(val).map(key => ({...val[key], key})) : [];
                    this.isLoading = false;
                });

                db.ref('board/background').on('value', s => {
                    this.bgImage = s.val() || '';
                    if (!this.bgImage) {
                        // æ²’åœ–æ™‚ï¼Œé‡è¨­ç‚ºé è¨­å¤§å°
                        this.canvasW = 1280;
                        this.canvasH = 720;
                    }
                    // æœ‰åœ–æ™‚ç”± onImgLoad è™•ç†å¤§å°
                });
                
                db.ref('board/settings').on('value', s => {
                    const val = s.val() || {};
                    this.zones = (val.zones || []).map(z => ({ ...z, draftText: '' }));
                    this.promptSuffix = val.promptSuffix || 'çš„æƒ³æ³•';
                });
                
                // é è¨­ç½®ä¸­
                this.resetView();
            },
            methods: {
                // === ç•«å¸ƒæ“ä½œé‚è¼¯ (Pan & Zoom) ===
                onImgLoad(e) {
                    // åœ–ç‰‡è¼‰å…¥å¾Œï¼Œå°‡ç•«å¸ƒå¤§å°è¨­ç‚ºåœ–ç‰‡åŸå§‹å¤§å°
                    this.canvasW = e.target.naturalWidth;
                    this.canvasH = e.target.naturalHeight;
                    this.resetView(); // è¼‰å…¥æ–°åœ–å¾Œè‡ªå‹•ç½®ä¸­
                },
                startPan(e) {
                    this.panning = true;
                    this.startX = e.clientX - this.pointX;
                    this.startY = e.clientY - this.pointY;
                    window.addEventListener('mousemove', this.onPan);
                    window.addEventListener('mouseup', this.stopPan);
                },
                onPan(e) {
                    if (!this.panning) return;
                    e.preventDefault();
                    this.pointX = e.clientX - this.startX;
                    this.pointY = e.clientY - this.startY;
                },
                stopPan() {
                    this.panning = false;
                    window.removeEventListener('mousemove', this.onPan);
                    window.removeEventListener('mouseup', this.stopPan);
                },
                handleZoom(e) {
                    const zoomSensitivity = 0.001;
                    const delta = -e.deltaY * zoomSensitivity;
                    const newScale = Math.min(Math.max(0.1, this.scale + delta), 5); // é™åˆ¶ç¸®æ”¾ 0.1x ~ 5x
                    
                    // æ»‘é¼ ç‚ºä¸­å¿ƒç¸®æ”¾ç®—æ³•
                    // 1. å–å¾—æ»‘é¼ åœ¨ç•«å¸ƒå…§çš„ç›¸å°ä½ç½® (é‚„æ²’ç¸®æ”¾å‰)
                    const mouseX = e.clientX - this.pointX;
                    const mouseY = e.clientY - this.pointY;

                    // 2. è¨ˆç®—æ–°çš„ä½ç§»é‡ï¼Œè®“æ»‘é¼ åº•ä¸‹çš„é»ä¿æŒä¸å‹•
                    // å…¬å¼ï¼šæ–°çš„åç§» = æ»‘é¼ ä½ç½® - (æ»‘é¼ åœ¨èˆŠç¸®æ”¾ä¸‹çš„ç›¸å°å€¼ * æ–°ç¸®æ”¾ç‡)
                    // ä½†é€™è£¡ç°¡åŒ–è™•ç†ï¼šç›´æ¥èª¿æ•´ pointX/Y ä¾†è£œå„Ÿ
                    // å¯¦éš›ä¸Šç°¡å–®åšæ³•ï¼š
                    // this.pointX -= mouseX / this.scale * (newScale - this.scale);
                    // this.pointY -= mouseY / this.scale * (newScale - this.scale);
                    
                    // é€™è£¡ä½¿ç”¨æ›´ç›´è¦ºçš„ä¸­å¿ƒç¸®æ”¾
                    const ratio = 1 - newScale / this.scale;
                    this.pointX += (e.clientX - this.pointX) * ratio;
                    this.pointY += (e.clientY - this.pointY) * ratio;

                    this.scale = newScale;
                },
                resetView() {
                    // è‡ªå‹•è¨ˆç®—æœ€é©åˆçš„ç¸®æ”¾æ¯”ä¾‹ (Contain)
                    const winW = window.innerWidth;
                    const winH = window.innerHeight;
                    const scaleW = winW / this.canvasW;
                    const scaleH = winH / this.canvasH;
                    
                    // ç•™ä¸€é»é‚Šè· (0.9)
                    this.scale = Math.min(scaleW, scaleH) * 0.9;
                    
                    // ç½®ä¸­
                    this.pointX = (winW - this.canvasW * this.scale) / 2;
                    this.pointY = (winH - this.canvasH * this.scale) / 2;
                },

                // === ä¾¿åˆ©è²¼æ‹–æ›³ (é‚è¼¯ä¿®æ­£) ===
                startDragNote(e, note) {
                    this.draggingNote = note;
                    this.noteDragStartX = e.clientX;
                    this.noteDragStartY = e.clientY;
                    this.noteInitialPercentX = note.x;
                    this.noteInitialPercentY = note.y;
                    
                    window.addEventListener('mousemove', this.onNoteDrag);
                    window.addEventListener('mouseup', this.stopNoteDrag);
                },
                onNoteDrag(e) {
                    if (!this.draggingNote) return;
                    e.preventDefault();
                    
                    // 1. è¨ˆç®—æ»‘é¼ ç§»å‹•çš„åƒç´ è·é›¢
                    const dxPx = e.clientX - this.noteDragStartX;
                    const dyPx = e.clientY - this.noteDragStartY;
                    
                    // 2. é—œéµï¼šå°‡åƒç´ è·é›¢è½‰ç‚ºç•«å¸ƒç™¾åˆ†æ¯”
                    // ç§»å‹•è·é›¢ / (ç•«å¸ƒç•¶å‰æ¸²æŸ“å¯¬åº¦) * 100
                    // ç•«å¸ƒæ¸²æŸ“å¯¬åº¦ = åŸå§‹å¯¬åº¦ * ç¸®æ”¾ç‡
                    const dxPercent = (dxPx / (this.canvasW * this.scale)) * 100;
                    const dyPercent = (dyPx / (this.canvasH * this.scale)) * 100;

                    this.draggingNote.x = this.noteInitialPercentX + dxPercent;
                    this.draggingNote.y = this.noteInitialPercentY + dyPercent;
                },
                stopNoteDrag() {
                    if (this.draggingNote) {
                        const { key, x, y } = this.draggingNote;
                        db.ref(`board/notes/${key}`).update({ x, y });
                        this.draggingNote = null;
                        window.removeEventListener('mousemove', this.onNoteDrag);
                        window.removeEventListener('mouseup', this.stopNoteDrag);
                    }
                },

                // === ä»¥ä¸‹ä¿æŒåŸé‚è¼¯ ===
                sendZoneNote(zone) {
                    if (!zone.draftText.trim()) return;
                    const pos = this.calcPercentPosition(zone.pos);
                    db.ref('board/notes').push({
                        text: zone.draftText, studentId: this.studentId, zoneName: zone.name,
                        x: pos.x, y: pos.y, timestamp: Date.now()
                    });
                    zone.draftText = '';
                },
                sendFreeNote() {
                    if (!this.freeText.trim()) return;
                    db.ref('board/notes').push({
                        text: this.freeText, studentId: this.studentId, zoneName: '',
                        x: 10 + Math.random() * 60, y: 20 + Math.random() * 60, timestamp: Date.now()
                    });
                    this.freeText = '';
                },
                calcPercentPosition(posCode) {
                    const rand = () => (Math.random() - 0.5) * 5;
                    let x = 40, y = 40;
                    switch(posCode) {
                        case 'TL': x = 5;  y = 5; break;   case 'T':  x = 40; y = 5; break;   case 'TR': x = 75; y = 5; break;
                        case 'L':  x = 5;  y = 40; break;  case 'C':  x = 40; y = 40; break;  case 'R':  x = 75; y = 40; break;
                        case 'BL': x = 5;  y = 75; break;  case 'B':  x = 40; y = 75; break;  case 'BR': x = 75; y = 75; break;
                    }
                    return { x: x + rand(), y: y + rand() };
                },
                getLocationLabel(code) {
                    const map = { 'TL': 'â†– å·¦ä¸Š', 'T': 'â†‘ ä¸Šæ–¹', 'TR': 'â†— å³ä¸Š', 'L': 'â† å·¦å´', 'C': 'â— ä¸­é–“', 'R': 'â†’ å³å´', 'BL': 'â†™ å·¦ä¸‹', 'B': 'â†“ ä¸‹æ–¹', 'BR': 'â†˜ å³ä¸‹' };
                    return map[code] || '';
                },
                addTempZone() { this.tempZones.push({ name: '', pos: 'C' }); },
                removeTempZone(idx) { this.tempZones.splice(idx, 1); },
                saveZones() {
                    const finalZones = this.tempZones.filter(z => z.name.trim() !== '');
                    db.ref('board/settings').update({ zones: finalZones, promptSuffix: this.tempSuffix || 'çš„æƒ³æ³•' });
                    this.showZoneModal = false;
                },
                handleBgUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    if (file.size > 2 * 1024 * 1024) { alert('åœ–æª”éå¤§'); return; }
                    const reader = new FileReader();
                    reader.onload = (e) => db.ref('board/background').set(e.target.result);
                    reader.readAsDataURL(file);
                },
                removeBackground() { if(confirm('ç¢ºå®šç§»é™¤èƒŒæ™¯ï¼Ÿ')) db.ref('board/background').remove(); },
                deleteNote(key) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) db.ref(`board/notes/${key}`).remove(); },
                clearBoard() { if(confirm('ç¢ºå®šæ¸…ç©ºï¼Ÿ')) db.ref('board/notes').remove(); },
                getColorClass(key) { return `color-${(key.charCodeAt(key.length-1)%4)+1}`; },
                openEditModal(note) { this.editingNote = { ...note }; this.showEditModal = true; },
                confirmEdit() {
                    const { key, text } = this.editingNote;
                    db.ref('board/notes/' + key).update({ text });
                    this.showEditModal = false;
                },
            },
            watch: {
                showZoneModal(val) { if (val) { this.tempZones = JSON.parse(JSON.stringify(this.zones)); this.tempSuffix = this.promptSuffix; } }
            }
        }).mount('#app');
    </script>
</body>
</html>
